{% extends 'user_querySafe/include/base.html' %}
{% load static %}
{% block title %}
  Conversations | {{ block.super }}
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'user_querySafe/css/conversations.css' %}">
  <div class="container-fluid py-3">
    <div class="row">
      <div class="col-12">
        <!-- Page Header Card -->
        <div class="card bg-gradient-dark mb-4 border-0">
          <div class="card-header bg-transparent border-0">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-white mb-1">Conversations</h6>
                <p class="text-sm text-white-50 mb-0">Manage and monitor all your chatbot conversations</p>
              </div>
              <div class="d-flex gap-2">
                <a href="{% url 'my_chatbots' %}" class="btn btn-sm btn-white">
                  <i class="material-symbols-rounded align-middle me-1">smart_toy</i>
                  My Chatbots
                </a>
              </div>
            </div>
          </div>
        </div>

        <!-- Main Content Card -->
        <div class="card border-0 shadow-sm">
          <div class="row g-0" style="min-height: calc(100vh - 250px);">
            <!-- Chatbot Selection Sidebar -->
            <div class="col-md-3 col-lg-2 border-end">
              <div class="p-3 border-bottom bg-light">
                <h6 class="text-uppercase text-muted fw-bold mb-0">
                  <i class="material-symbols-rounded align-middle me-2">smart_toy</i>
                  My Chatbots
                </h6>
              </div>
              <div class="chatbot-list p-3 overflow-y-auto" style="height: calc(100vh - 320px);">
                {% for bot in chatbots %}
                  <a href="{% url 'conversations_by_chatbot' bot.chatbot_id %}" class="chatbot-item">
                    <div class="d-flex align-items-center p-3 rounded-3 mb-2 {% if bot.chatbot_id == selected_bot.chatbot_id %}active{% endif %}">
                      <!-- Chatbot Avatar -->
                      <div class="chatbot-avatar {% if not bot.logo %}
                          bg-gradient-
                          {% if bot.status == 'trained' %}
                            primary
                          {% elif bot.status == 'training' %}
                            warning
                          {% else %}
                            secondary
                          {% endif %}
                        {% endif %}">
                        {% if bot.logo %}
                          <img src="{{ bot.logo.url }}" alt="{{ bot.name }}" class="chatbot-logo" />
                        {% else %}
                          <i class="material-symbols-rounded">smart_toy</i>
                        {% endif %}
                      </div>
                      <div class="ms-3 overflow-hidden">
                        <h6 class="text-sm mb-1 text-truncate">{{ bot.name }}</h6>
                        <span class="status-badge status-{{ bot.status }}" data-status="{{ bot.status }}">
                          <i class="material-symbols-rounded">
                            {% if bot.status == 'trained' %}
                              check_circle
                            {% elif bot.status == 'training' %}
                              pending
                            {% else %}
                              error
                            {% endif %}
                          </i>
                          {{ bot.status|title }}
                        </span>
                      </div>
                    </div>
                  </a>
                {% endfor %}
              </div>
            </div>

            <!-- Conversations List -->
            <div class="col-md-4 col-lg-3 border-end">
              <div class="p-3 border-bottom bg-light">
                <div class="d-flex align-items-center justify-content-between">
                  <h6 class="text-uppercase text-muted fw-bold mb-0">
                    <i class="material-symbols-rounded align-middle me-2">forum</i>
                    Conversations
                  </h6>
                  <span class="badge bg-gradient-primary rounded-pill">{{ conversations|length }}</span>
                </div>
              </div>
              <div class="conversations-list p-3 overflow-y-auto" style="height: calc(100vh - 320px);">
                {% for conversation in conversations %}
                  <a href="{% url 'conversation_detail' selected_bot.chatbot_id conversation.conversation_id %}" class="conversation-item">
                    <div class="p-3 rounded-3 mb-2 {% if conversation.conversation_id == selected_conversation.conversation_id %}active{% endif %}">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center">
                          <div class="conversation-avatar bg-gradient-info">
                            <i class="material-symbols-rounded text-white">person</i>
                          </div>
                          <div class="ms-2 overflow-hidden">
                            <h6 class="text-sm mb-0 text-truncate">User #{{ conversation.user_id|truncatechars:8 }}</h6>
                            <small class="text-muted">{{ conversation.last_updated|timesince }} ago</small>
                          </div>
                        </div>
                        {% if conversation.unread_count %}
                          <span class="badge bg-danger rounded-pill">{{ conversation.unread_count }}</span>
                        {% endif %}
                      </div>
                      <p class="text-sm text-muted mb-0 text-truncate">{{ conversation.last_message }}</p>
                    </div>
                  </a>
                {% endfor %}
              </div>
            </div>

            <!-- Chat Messages -->
            <div class="col-md-5 col-lg-7">
              {% if selected_conversation %}
                <div class="d-flex flex-column h-100">
                  <!-- Chat Header -->
                  <div class="p-3 border-bottom bg-light">
                    <div class="d-flex align-items-center">
                      <div class="chat-avatar bg-gradient-dark">
                        <i class="material-symbols-rounded text-white">person</i>
                      </div>
                      <div class="ms-3">
                        <h6 class="mb-1">User #{{ selected_conversation.user_id }}</h6>
                        <div class="d-flex align-items-center text-muted">
                          <i class="material-symbols-rounded me-1">schedule</i>
                          <small>Started {{ selected_conversation.started_at|date:'M d, Y' }}</small>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Messages Area -->
                  <div class="chat-messages flex-grow-1 p-4 overflow-y-auto" tabindex="0">
                    {% for message in messages %}
                      <div class="message {% if message.is_bot %}
                          message-left
                        {% else %}
                          message-right
                        {% endif %}">
                        <div class="message-content">
                          <div class="message-text">{{ message.content|linebreaks }}</div>
                          <div class="message-time">
                            <i class="material-symbols-rounded" style="font-size: 12px;">schedule</i>
                            {{ message.timestamp|date:'g:i A' }}
                          </div>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              {% else %}
                <div class="d-flex flex-column align-items-center justify-content-center h-100 p-4">
                  <div class="empty-state-icon mb-3">
                    <i class="material-symbols-rounded">forum</i>
                  </div>
                  <h5 class="mb-2">Select a Conversation</h5>
                  <p class="text-muted">Choose a chatbot and conversation to view messages</p>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

{% endblock %}
